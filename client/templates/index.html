<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Room Reservation System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
    <div class="container-fluid">
        <div class="row min-vh-100">
            <div class="col-lg-6 d-flex align-items-center justify-content-center bg-primary">
                <div class="text-center text-white">
                    <i class="fas fa-university fa-5x mb-4"></i>
                    <h1 class="display-4 mb-4">University Room Reservation</h1>
                    <p class="lead">Blockchain-powered room booking system for blocks 33, 34, and 35</p>
                    <div class="mt-4">
                        <div class="d-flex justify-content-center">
                            <div class="me-4">
                                <i class="fas fa-building fa-2x mb-2"></i>
                                <p>3 Blocks</p>
                            </div>
                            <div class="me-4">
                                <i class="fas fa-door-open fa-2x mb-2"></i>
                                <p>45 Rooms</p>
                            </div>
                            <div>
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <p>06:00-23:00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 d-flex align-items-center justify-content-center">
                <div class="login-form">
                    <div class="text-center mb-5">
                        <h2>Welcome</h2>
                        <p class="text-muted">Please select your role to continue</p>
                    </div>

                    <form id="loginForm">
                        <div class="mb-4">
                            <label class="form-label">Select Your Role</label>
                            <div class="role-selection">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="user_type" id="student"
                                        value="student" required>
                                    <label class="form-check-label" for="student">
                                        <i class="fas fa-user-graduate me-2"></i>Student
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="user_type" id="professor"
                                        value="professor" required>
                                    <label class="form-check-label" for="professor">
                                        <i class="fas fa-chalkboard-teacher me-2"></i>Professor
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="user_id" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="user_id" name="user_id" required>
                            <div id="user-id-feedback" class="form-text"></div>
                        </div>

                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                            <div id="name-feedback" class="form-text"></div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email <small class="text-muted">(optional for
                                    returning users)</small></label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" required
                                    minlength="6" autocomplete="new-password">
                                <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="password-feedback" class="form-text">
                                <small class="text-muted">Minimum 6 characters required</small>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="block" class="form-label">Primary Block</label>
                            <select class="form-select" id="block" name="block" required>
                                <option value="33">Block 33</option>
                                <option value="34">Block 34</option>
                                <option value="35">Block 35</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            <i class="fas fa-sign-in-alt me-2"></i>Enter System
                        </button>
                    </form>

                    <div class="text-center mt-4">
                        <small class="text-muted">
                            Powered by Hyperledger Fabric
                        </small>
                        <br>
                        <div class="mt-3">
                            <h6 class="text-muted">Quick Access:</h6>
                            <div class="d-flex flex-column gap-2">
                                <a href="/blockchain" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-cubes me-1"></i>Blockchain Explorer
                                </a>
                                <a href="/monitor" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-chart-line me-1"></i>System Monitor
                                </a>
                                <a href="/navigation" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-compass me-1"></i>All Routes
                                </a>
                            </div>
                        </div>

                        <!-- Recent Users Section -->
                        <div class="mt-4" id="recent-users-section" style="display: none;">
                            <h6 class="text-muted">Recent Users:</h6>
                            <div id="recent-users-list" class="d-flex flex-column gap-1">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Connecting to Blockchain Network...</h5>
                    <p class="text-muted">Please wait while we authenticate your credentials</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let userCheckTimeout = null;
        let nameCheckTimeout = null;

        $(document).ready(function () {
            // Load recent users on page load
            loadRecentUsers();

            // Password toggle functionality
            $('#toggle-password').on('click', function () {
                const passwordField = $('#password');
                const icon = $(this).find('i');

                if (passwordField.attr('type') === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });

            // Real-time user ID checking
            $('#user_id').on('input', function () {
                clearTimeout(userCheckTimeout);
                const userId = $(this).val().trim();

                if (userId.length >= 3) {
                    userCheckTimeout = setTimeout(() => {
                        checkUserExists(userId);
                    }, 500);
                } else {
                    $('#user-id-feedback').html('');
                }
            });

            // Real-time name checking
            $('#name').on('input', function () {
                clearTimeout(nameCheckTimeout);
                const name = $(this).val().trim();

                if (name.length >= 3) {
                    nameCheckTimeout = setTimeout(() => {
                        checkNameExists(name);
                    }, 500);
                } else {
                    $('#name-feedback').html('');
                }
            });

            $('#loginForm').on('submit', function (e) {
                e.preventDefault();

                const formData = {
                    user_type: $('input[name="user_type"]:checked').val(),
                    user_id: $('#user_id').val().trim(),
                    name: $('#name').val().trim(),
                    email: $('#email').val().trim(),
                    password: $('#password').val(),
                    block: $('#block').val()
                };

                // Validate required fields
                if (!formData.user_type || !formData.user_id || !formData.name || !formData.password) {
                    alert('Please fill in User ID, Name, Password, and select your role');
                    return;
                }

                // Validate password length
                if (formData.password.length < 6) {
                    alert('Password must be at least 6 characters long');
                    return;
                }

                // Disable submit button to prevent double submission
                $('#loginForm button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Connecting...');

                // Show loading modal
                $('#loadingModal').modal('show');

                $.ajax({
                    url: '/api/login',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    timeout: 10000, // 10 second timeout
                    success: function (response) {
                        $('#loadingModal').modal('hide');

                        // Re-enable submit button
                        $('#loginForm button[type="submit"]').prop('disabled', false).html('<i class="fas fa-sign-in-alt me-2"></i>Enter System');

                        if (response.success) {
                            // Show appropriate welcome message
                            if (response.returning_user) {
                                showAlert('success', response.message);
                            } else if (response.new_user) {
                                showAlert('success', response.message);
                            }

                            setTimeout(() => {
                                window.location.href = response.redirect;
                            }, 1500);
                        } else {
                            showAlert('error', response.error);
                        }
                    },
                    error: function (xhr, status, error) {
                        $('#loadingModal').modal('hide');

                        // Re-enable submit button
                        $('#loginForm button[type="submit"]').prop('disabled', false).html('<i class="fas fa-sign-in-alt me-2"></i>Enter System');

                        let errorMessage = 'Login failed: ';
                        if (status === 'timeout') {
                            errorMessage += 'Connection timeout. Please check your connection and try again.';
                        } else if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMessage += xhr.responseJSON.error;
                        } else {
                            errorMessage += error || 'Unknown error occurred';
                        }

                        showAlert('error', errorMessage);
                    }
                });
            });
        });

        async function checkUserExists(userId) {
            try {
                const response = await fetch(`/api/check-user/${encodeURIComponent(userId)}`);
                const data = await response.json();

                if (data.success && data.user_exists) {
                    const user = data.user_info;
                    $('#user-id-feedback').html(`
                        <div class="text-success">
                            <i class="fas fa-check-circle me-1"></i>
                            Welcome back, ${user.name}! (${user.userType} in Block ${user.block})
                        </div>
                    `);

                    // Auto-fill known user data (but NOT password for security)
                    $('#name').val(user.name);
                    $('#block').val(user.block);
                    $(`input[name="user_type"][value="${user.userType}"]`).prop('checked', true);

                    // Make email optional for returning users
                    $('#email').removeAttr('required');

                    // Clear password field and focus on it
                    $('#password').val('').focus();
                    $('#password-feedback').html(`
                        <small class="text-info">
                            <i class="fas fa-shield-alt me-1"></i>
                            Please enter your password to continue
                        </small>
                    `);

                } else if (data.success && !data.user_exists) {
                    $('#user-id-feedback').html(`
                        <div class="text-info">
                            <i class="fas fa-info-circle me-1"></i>
                            New user - please complete registration
                        </div>
                    `);
                    $('#email').attr('required', true);
                    $('#password').val('');
                    $('#password-feedback').html(`
                        <small class="text-muted">Create a password (minimum 6 characters)</small>
                    `);
                }
            } catch (error) {
                console.error('Error checking user:', error);
            }
        }

        async function checkNameExists(name) {
            try {
                const response = await fetch(`/api/check-name/${encodeURIComponent(name)}`);
                const data = await response.json();

                if (data.success && data.suggestions_count > 0) {
                    const suggestions = data.similar_users.map(user =>
                        `<span class="badge bg-info me-1">${user.name} (${user.id})</span>`
                    ).join('');

                    $('#name-feedback').html(`
                         <div class="text-info">
                             <i class="fas fa-info-circle me-1"></i>
                             Similar users found: ${suggestions}
                             <br><small class="text-muted">Names can be duplicated - this is just for your information</small>
                         </div>
                     `);
                } else {
                    $('#name-feedback').html('');
                }
            } catch (error) {
                console.error('Error checking name:', error);
            }
        }

        function showAlert(type, message) {
            const alertClass = type === 'error' ? 'danger' : type;
            const alertHtml = `
                <div class="alert alert-${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                    <i class="fas fa-${getAlertIcon(type)} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            $('body').append(alertHtml);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 3000);
        }

        async function loadRecentUsers() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();

                if (data.success && data.connected_users && data.connected_users.length > 0) {
                    const recentUsersHtml = data.connected_users.slice(0, 3).map(user => `
                        <button class="btn btn-outline-secondary btn-sm w-100 text-start" 
                                onclick="quickLogin('${user.user_id}', '${user.user_type}')">
                            <i class="fas fa-${user.user_type === 'professor' ? 'chalkboard-teacher' : 'user-graduate'} me-2"></i>
                            ${user.user_id} (${user.user_type})
                        </button>
                    `).join('');

                    $('#recent-users-list').html(recentUsersHtml);
                    $('#recent-users-section').show();
                }
            } catch (error) {
                console.error('Error loading recent users:', error);
            }
        }

        function quickLogin(userId, userType) {
            $('#user_id').val(userId);
            $(`input[name="user_type"][value="${userType}"]`).prop('checked', true);

            // Trigger user check to auto-fill data
            setTimeout(() => {
                checkUserExists(userId);
            }, 100);
        }

        function getAlertIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                case 'info': return 'info-circle';
                default: return 'info-circle';
            }
        }
    </script>
</body>

</html>